<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Genre Fusion Listening Survey</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 750px; margin: 40px auto; line-height: 1.6; }
    audio { width: 100%; margin: 10px 0; }
    button { margin: 6px; padding: 10px 20px; font-size: 16px; }
    #survey { margin-top: 30px; }
    h2, h3 { color: #222; }
  </style>
</head>
<body>
  <h2>ðŸŽµ Genre Fusion Listening Survey</h2>
  <p>
    You will listen to pairs of musical clips from different genre transitions.
    For each pair, choose the one that best represents a <b>fusion</b> of both genres.
  </p>

  <div id="survey">
    <h3>Before we start...</h3>
    <p>Do you actively perform or practice music?</p>
    <button id="yes-btn">Yes</button>
    <button id="no-btn">No</button>
  </div>

  <div id="trial-container"></div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1yE9of1RTFf8BMVrtr3IiNy5VUOiM4o0XhjfWttPT9g-nIpvYpo3SBQaZC9TYDnMmeA/exec";

    const AUDIO_FOLDER = "audio";
    const ids = {
      "classical_electronic": {
        "steered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/SteeredSamples/classical_electronic_${i+1}.wav`),
        "unsteered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/UnSteeredSamples/classical_electronic_${i+1}.wav`)
      },
      "electronic_jazz": {
        "steered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/SteeredSamples/electronic_jazz_${i+1}.wav`),
        "unsteered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/UnSteeredSamples/electronic_jazz_${i+1}.wav`)
      },
      "jazz_rock": {
        "steered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/SteeredSamples/jazz_rock_${i+1}.wav`),
        "unsteered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/UnSteeredSamples/jazz_rock_${i+1}.wav`)
      },
      "rock_classical": {
        "steered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/SteeredSamples/rock_classical_${i+1}.wav`),
        "unsteered": Array.from({length:20}, (_,i) => `${AUDIO_FOLDER}/UnSteeredSamples/rock_classical_${i+1}.wav`)
      }
    };

    // Build all audio pairs
    const AUDIO_PAIRS = [];
    Object.keys(ids).forEach(t => {
      const steered = ids[t].steered;
      const unsteered = ids[t].unsteered;
      const n = Math.min(steered.length, unsteered.length);
      for (let i = 0; i < n; i++) {
        AUDIO_PAIRS.push({
          transition: t.replace("_", " â†’ "),
          pair_id: `${t}_${i + 1}`,
          clipA: steered[i],
          clipB: unsteered[i],
          A_is_steered: true
        });
      }
    });

    // Sample 6 pairs per transition
    function samplePairs() {
      const selected = [];
      const grouped = {};
      AUDIO_PAIRS.forEach(p => {
        const t = p.transition;
        grouped[t] = grouped[t] || [];
        grouped[t].push(p);
      });
      Object.keys(grouped).forEach(t => {
        selected.push(...grouped[t].sort(() => Math.random() - 0.5).slice(0, 6));
      });
      return selected.sort(() => Math.random() - 0.5);
    }

    const selectedPairs = samplePairs();
    const participant_id = "P" + Math.floor(1000 + Math.random() * 9000);
    let trial_index = 0;
    let isMusicallyKnowledgeable = false;

    // Yes/No buttons
    document.getElementById("yes-btn").addEventListener("click", () => startSurvey(true));
    document.getElementById("no-btn").addEventListener("click", () => startSurvey(false));

    function startSurvey(knowledgeable) {
      isMusicallyKnowledgeable = knowledgeable;
      document.getElementById("survey").style.display = "none"; // hide initial question
      renderTrial();
    }

    function renderTrial() {
      const trialDiv = document.getElementById("trial-container");

      if (trial_index >= selectedPairs.length) {
        trialDiv.innerHTML = `<h3>Thank you! Your responses have been recorded.</h3>`;
        return;
      }

      const t = selectedPairs[trial_index];
      const clips = Math.random() > 0.5
        ? [{src: t.clipA, label: "A", isSteered: t.A_is_steered},
           {src: t.clipB, label: "B", isSteered: !t.A_is_steered}]
        : [{src: t.clipB, label: "A", isSteered: !t.A_is_steered},
           {src: t.clipA, label: "B", isSteered: t.A_is_steered}];

      trialDiv.innerHTML = `
        <h3>Trial ${trial_index + 1} / ${selectedPairs.length}</h3>
        <h4>Transition: ${t.transition}</h4>

        <p><b>Clip A</b></p>
        <audio controls src="${clips[0].src}"></audio>

        <p><b>Clip B</b></p>
        <audio controls src="${clips[1].src}"></audio>

        <div id="question">
          <p>Which clip sounds more like a <b>fusion</b> of the two genres?</p>
          <button id="btnA">Clip A</button>
          <button id="btnB">Clip B</button>
        </div>
      `;

      document.getElementById("btnA").addEventListener("click", () => submitResponse(clips[0].label, clips[0].isSteered));
      document.getElementById("btnB").addEventListener("click", () => submitResponse(clips[1].label, clips[1].isSteered));
    }

    function submitResponse(choiceLabel, choiceIsSteered) {
      const t = selectedPairs[trial_index];

      const data = {
        participant_id,
        musically_knowledgeable: isMusicallyKnowledgeable,
        trial_index: trial_index + 1,
        transition: t.transition,
        pair_id: t.pair_id,
        choice: choiceLabel,
        choice_is_steered: choiceIsSteered
      };

      // Disable buttons immediately
      document.getElementById("btnA").disabled = true;
      document.getElementById("btnB").disabled = true;

      // Send data
      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });

      // Immediately load next trial
      trial_index++;
      renderTrial();
    }
  </script>
</body>
</html>

